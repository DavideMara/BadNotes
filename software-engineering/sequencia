@startuml
title Secuencia: Modificar Anuncio
actor "Usuario Registrado" as User
participant ":Vista Usuario" as View
participant ":Gestion de Anuncios" as Controller
participant ":Datos Anuncios" as AdDAO

autonumber

User -> View : Clic en "Guardar Cambios"
activate View

' 1. The Controller receives the ID and the new object
' Source: Page 13 (IGestionModificarAnuncios)
View -> Controller : editarDatosAnuncio(idAnuncio: String, datosNuevos: Anuncio)
activate Controller

' 2. Retrieve the CURRENT ad to verify ownership
' Source: Page 14 (DAOAnuncios)
Controller -> AdDAO : verAnuncio(idAnuncio)
activate AdDAO
AdDAO --> Controller : anuncioOriginal: Anuncio
deactivate AdDAO

alt anuncioOriginal == null
    Controller --> View : Error: El anuncio no existe
else Anuncio Encontrado

    ' 3. Security Validation (Logic inside Controller)
    ' We check if the ad's owner ID matches the current session user
    alt anuncioOriginal.usuarioId != usuarioLogueado.id
        Controller --> View : Error: No tienes permisos (No es tu anuncio)
    else Permisos Correctos
    
        ' 4. Business Validation (Prices, bad words, etc.)
        Controller -> Controller : validarDatos(datosNuevos)
        
        alt Datos Inválidos
            Controller --> View : Error: Datos incorrectos
        else Datos Válidos
        
            ' 5. Persist the changes
            ' Source: Page 14 (DAOAnuncios)
            Controller -> AdDAO : modificarAnuncio(datosNuevos)
            activate AdDAO
            AdDAO --> Controller : true
            deactivate AdDAO
            
            Controller --> View : true (Éxito)
        end
    end
end

deactivate Controller
deactivate View
@enduml